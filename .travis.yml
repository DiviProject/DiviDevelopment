os: linux
dist: bionic
language: cpp

services:
  - docker

script:
  # Compile from source
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - cd divi
  - docker build -t divi -f DockerfileWithTests .
  - docker run -t -d --name test_container divi
  - docker container ls -a
  - container_id=$(docker ps -aqf "name=test_container")
  - echo "${container_id}"
  - docker exec -it ${container_id} sh -c 'make check && cd qa/rpc-tests/ && ./test_runner.py && exit'

after_failure:
  - cat ./src/test-suite.log